name: Browser-based Mac Desktop
on: workflow_dispatch

jobs:
  browser-mac:
    runs-on: macos-latest
    steps:
      - name: Setup Full Desktop Access
        run: |
          # VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          brew install x11vnc
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ secrets.VNC_PASSWORD }}" ~/.vnc/passwd

          # ãƒ•ãƒ«ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’é…ä¿¡ï¼ˆä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ä½œæˆï¼‰
          x11vnc -create -geometry 1280x720 -forever -shared -rfbauth ~/.vnc/passwd -rfbport 5900 &
          sleep 5

      - name: Setup noVNC Web Interface
        run: |
          # noVNCãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          git clone --depth 1 https://github.com/novnc/noVNC.git
          cd noVNC

          # WebSocketãƒ—ãƒ­ã‚­ã‚·èµ·å‹•
          ./utils/launch.sh --vnc localhost:5900 --listen 6080 &
          sleep 5

      - name: Create ngrok Tunnel
        run: |
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 6080 &
          sleep 10

          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

          echo "=========================================="
          echo "ğŸ–¥ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã§macOSãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ã‚¢ã‚¯ã‚»ã‚¹"
          echo ""
          echo "ğŸ“± è‡ªå‹•æ¥ç¶šURL:"
          echo "$URL/vnc.html?autoconnect=true&password=${{ secrets.VNC_PASSWORD }}"
          echo ""
          echo "ğŸ” æ‰‹å‹•æ¥ç¶šURL:"
          echo "$URL/vnc.html"
          echo "ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: Your VNC_PASSWORDï¼‰"
          echo "=========================================="

      - name: Keep Alive
        run: sleep 21600
