name: Mac VNC with Login Verification
on: workflow_dispatch

jobs:
  mac-vnc:
    runs-on: macos-latest
    steps:
      - name: Setup and Test VNC
        run: |
          brew install x11vnc
          
          # VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          mkdir -p ~/.vnc
          echo "${{ secrets.VNC_PASSWORD }}" | x11vnc -storepasswd -f ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # macOSç”¨ï¼šcreateã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ä½œæˆ
          x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd &
          sleep 10
          
          # VNCã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ç¢ºèª
          echo "=== VNCã‚µãƒ¼ãƒãƒ¼ç¢ºèª ==="
          if pgrep -f x11vnc > /dev/null; then
            echo "âœ… x11vncãƒ—ãƒ­ã‚»ã‚¹: ç¨¼åƒä¸­"
          else
            echo "âŒ x11vncãƒ—ãƒ­ã‚»ã‚¹: åœæ­¢"
            exit 1
          fi
          
          if lsof -i :5900 > /dev/null; then
            echo "âœ… ãƒãƒ¼ãƒˆ5900: ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­"
          else
            echo "âŒ ãƒãƒ¼ãƒˆ5900: é–‰ã˜ã¦ã„ã¾ã™"
            exit 1
          fi
          
          # Pythonã§ç°¡æ˜“VNCæ¥ç¶šãƒ†ã‚¹ãƒˆ
          python3 -c "
          import socket
          try:
              s = socket.socket()
              s.settimeout(5)
              s.connect(('127.0.0.1', 5900))
              data = s.recv(12)
              if b'RFB' in data:
                  print('âœ… VNCãƒ—ãƒ­ãƒˆã‚³ãƒ«å¿œç­”: OK')
                  print(f'   ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {data.decode().strip()}')
              s.close()
          except Exception as e:
              print(f'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
              exit(1)
          "
          
          echo ""
          echo "âœ… VNCã‚µãƒ¼ãƒãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "   èªè¨¼æ–¹å¼: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼"
          echo "   ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ä¸è¦"
          echo "   ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: è¨­å®šæ¸ˆã¿ï¼ˆVNC_PASSWORDï¼‰"

      - name: Setup noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          ./utils/novnc_proxy --vnc 127.0.0.1:5900 --listen 127.0.0.1:6080 &
          sleep 5
          
          # noVNCã®å‹•ä½œç¢ºèª
          if curl -s http://127.0.0.1:6080 > /dev/null; then
            echo "âœ… noVNC Webã‚µãƒ¼ãƒãƒ¼: ç¨¼åƒä¸­"
          else
            echo "âŒ noVNC Webã‚µãƒ¼ãƒãƒ¼: ã‚¨ãƒ©ãƒ¼"
            exit 1
          fi

      - name: Setup ngrok and Show Info
        run: |
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 127.0.0.1:6080 &
          sleep 10
          
          URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "âŒ ngrok URLã®å–å¾—ã«å¤±æ•—"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "ğŸ‰ VNCæ¥ç¶šæº–å‚™å®Œäº†ï¼ˆå…¨ãƒ†ã‚¹ãƒˆåˆæ ¼ï¼‰"
          echo "=========================================="
          echo "ğŸ“ URL: $URL"
          echo ""
          echo "âœ… å‹•ä½œç¢ºèªæ¸ˆã¿ã®èªè¨¼æƒ…å ±:"
          echo "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ä¸è¦ï¼ˆç©ºæ¬„ã§OKï¼‰"
          echo "ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: Your VNC_PASSWORD"
          echo ""
          echo "ğŸ’¡ ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã‚‰:"
          echo "   - ç©ºæ¬„ã®ã¾ã¾é€²ã‚€"
          echo "   - ã¾ãŸã¯ã€Œrunnerã€ã¨å…¥åŠ›"
          echo "=========================================="

      - name: Keep Alive
        run: sleep 21600