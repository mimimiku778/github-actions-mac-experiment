name: Interactive Mac Environment
on: workflow_dispatch

jobs:
  interactive-mac:
    runs-on: macos-latest
    steps:
      - name: System Info
        run: |
          echo "=== System Information ==="
          sw_vers
          echo "User: $(whoami)"
          echo "=== Network Info ==="
          ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1

      - name: Setup VNC Server
        run: |
          # x11vncã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          brew install x11vnc
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ secrets.VNC_PASSWORD }}" ~/.vnc/passwd
          
          # ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã§VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•
          x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd -rfbport 5900 &
          sleep 5

      - name: Setup noVNC (Web-based VNC)
        run: |
          # noVNCã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          git clone --depth 1 https://github.com/novnc/noVNC.git
          cd noVNC
          
          # WebSocketãƒ—ãƒ­ã‚­ã‚·ã‚’èµ·å‹•
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      - name: Setup ngrok and Get URLs
        run: |
          # ngrokã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨èªè¨¼
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          
          # ãƒˆãƒ³ãƒãƒ«èµ·å‹•
          ngrok http 6080 > /tmp/ngrok-http.log 2>&1 &
          sleep 5
          ngrok tcp 5900 > /tmp/ngrok-tcp.log 2>&1 &
          sleep 5
          
          # URLå–å¾—
          WEB_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.config.addr=="http://localhost:6080") | .public_url' | head -1)
          VNC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.config.addr=="localhost:5900") | .public_url' | head -1)
          
          # GitHub Job Summaryã«è¡¨ç¤º
          echo "## ğŸ–¥ï¸ Remote Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Web Browser Access (Recommended)" >> $GITHUB_STEP_SUMMARY
          echo "URL: \`$WEB_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”Œ Direct VNC Access" >> $GITHUB_STEP_SUMMARY
          echo "URL: \`$VNC_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Password:** Use your VNC_PASSWORD secret" >> $GITHUB_STEP_SUMMARY
          
          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è¡¨ç¤º
          echo "=========================================="
          echo "ğŸŒ Web Browser Access: $WEB_URL"
          echo "ğŸ”Œ Direct VNC Access: $VNC_URL"
          echo "ğŸ”‘ Password: Your VNC_PASSWORD"
          echo "=========================================="

      - name: Keep Alive with Status
        run: |
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$(( (CURRENT_TIME - START_TIME) / 60 ))
            
            echo "[$(date '+%H:%M:%S')] Running for $ELAPSED minutes"
            
            # ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’æŠ‘åˆ¶ï¼‰
            if pgrep x11vnc > /dev/null; then
              echo "âœ… VNC server is running"
            else
              echo "âŒ VNC server stopped - restarting..."
              x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd -rfbport 5900 &
            fi
            
            # 5åˆ†å¾…æ©Ÿ
            sleep 300
          done