name: Fixed Mac VNC Access
on: workflow_dispatch

jobs:
  mac-vnc:
    runs-on: macos-latest
    steps:
      - name: Complete Setup
        run: |
          # VNCè¨­å®š
          brew install x11vnc
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ secrets.VNC_PASSWORD }}" ~/.vnc/passwd
          x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd &
          sleep 5
          
          # noVNCè¨­å®šï¼ˆæ­£ã—ã„æ–¹æ³•ï¼‰
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          
          # WebSocketãƒ—ãƒ­ã‚­ã‚·ã‚’æ­£ã—ãèµ·å‹•
          python3 -m websockify --web=. 6080 localhost:5900 &
          sleep 5
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          echo "=== noVNC files check ==="
          ls -la vnc.html || echo "vnc.html not found!"
          pwd
          
          # ngrokè¨­å®š
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 6080 &
          sleep 10
          
          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "=========================================="
          echo "ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹URLï¼ˆã“ã‚Œã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰:"
          echo ""
          echo "$URL/vnc.html"
          echo ""
          echo "ãƒšãƒ¼ã‚¸ãŒé–‹ã„ãŸã‚‰:"
          echo "1. Connectãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"
          echo "2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›: Your VNC_PASSWORD"
          echo "=========================================="

      - name: Keep Alive
        run: sleep 21600