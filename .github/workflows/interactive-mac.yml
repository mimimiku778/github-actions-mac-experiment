name: Interactive Mac Environment
on: workflow_dispatch

jobs:
  interactive-mac:
    runs-on: macos-latest
    steps:
      - name: System Info
        run: |
          echo "=== System Information ==="
          sw_vers
          echo "User: $(whoami)"
          echo "=== Network Info ==="
          ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1

      - name: Setup VNC Server
        run: |
          # x11vncをインストール
          brew install x11vnc
          
          # パスワードファイルを作成
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ secrets.VNC_PASSWORD }}" ~/.vnc/passwd
          
          # 仮想ディスプレイでVNCサーバー起動
          x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd -rfbport 5900 &
          sleep 5

      - name: Setup noVNC (Web-based VNC)
        run: |
          # noVNCをセットアップ
          git clone --depth 1 https://github.com/novnc/noVNC.git
          cd noVNC
          
          # WebSocketプロキシを起動
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      - name: Setup ngrok and Get URLs
        run: |
          # ngrokインストールと認証
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          
          # トンネル起動
          ngrok http 6080 > /tmp/ngrok-http.log 2>&1 &
          sleep 5
          ngrok tcp 5900 > /tmp/ngrok-tcp.log 2>&1 &
          sleep 5
          
          # URL取得
          WEB_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.config.addr=="http://localhost:6080") | .public_url' | head -1)
          VNC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.config.addr=="localhost:5900") | .public_url' | head -1)
          
          # GitHub Job Summaryに表示
          echo "## 🖥️ Remote Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🌐 Web Browser Access (Recommended)" >> $GITHUB_STEP_SUMMARY
          echo "URL: \`$WEB_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔌 Direct VNC Access" >> $GITHUB_STEP_SUMMARY
          echo "URL: \`$VNC_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Password:** Use your VNC_PASSWORD secret" >> $GITHUB_STEP_SUMMARY
          
          # コンソールにも表示
          echo "=========================================="
          echo "🌐 Web Browser Access: $WEB_URL"
          echo "🔌 Direct VNC Access: $VNC_URL"
          echo "🔑 Password: Your VNC_PASSWORD"
          echo "=========================================="

      - name: Keep Alive with Status
        run: |
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$(( (CURRENT_TIME - START_TIME) / 60 ))
            
            echo "[$(date '+%H:%M:%S')] Running for $ELAPSED minutes"
            
            # プロセス確認（エラー出力を抑制）
            if pgrep x11vnc > /dev/null; then
              echo "✅ VNC server is running"
            else
              echo "❌ VNC server stopped - restarting..."
              x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd -rfbport 5900 &
            fi
            
            # 5分待機
            sleep 300
          done