name: Mac VNC with Login Test
on: workflow_dispatch

jobs:
  mac-vnc:
    runs-on: macos-latest
    steps:
      - name: Setup VNC and Test Login
        run: |
          brew install x11vnc expect

          # VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆè¤‡æ•°ã®èªè¨¼æ–¹æ³•ã‚’è©¦ã™ï¼‰
          mkdir -p ~/.vnc

          # æ–¹æ³•1: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«èªè¨¼
          echo "${{ secrets.VNC_PASSWORD }}" | x11vnc -storepasswd -f ~/.vnc/passwd
          x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd -o /tmp/vnc1.log &
          VNC_PID1=$!
          sleep 5

          # VNCæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
          cat > /tmp/test_vnc.exp << 'EOF'
          #!/usr/bin/expect -f
          set timeout 10
          set password [lindex $argv 0]
          set port [lindex $argv 1]

          spawn vncviewer 127.0.0.1:$port
          expect {
            "Password:" {
              send "$password\r"
              expect {
                "Authentication successful" { exit 0 }
                "Authentication failed" { exit 1 }
                timeout { exit 2 }
              }
            }
            timeout { exit 3 }
          }
          EOF
          chmod +x /tmp/test_vnc.exp

          # Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§VNCèªè¨¼ãƒ†ã‚¹ãƒˆ
          cat > /tmp/test_vnc.py << 'EOF'
          import socket
          import sys

          def test_vnc_auth(host, port, password):
              try:
                  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  s.settimeout(5)
                  s.connect((host, port))
                  
                  # VNCãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯
                  data = s.recv(12)  # RFB xxx.xxx\n
                  s.send(data)       # Echo back
                  
                  # èªè¨¼ã‚¿ã‚¤ãƒ—
                  auth = s.recv(4)
                  
                  print(f"âœ… VNCã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ{port}ã§å¿œç­”ã—ã¦ã„ã¾ã™")
                  s.close()
                  return True
              except Exception as e:
                  print(f"âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")
                  return False

          if test_vnc_auth("127.0.0.1", 5900, sys.argv[1] if len(sys.argv) > 1 else ""):
              print("âœ… VNCæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ")
          EOF

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          python3 /tmp/test_vnc.py "${{ secrets.VNC_PASSWORD }}"

          # æˆåŠŸã—ãŸè¨­å®šã‚’è¨˜éŒ²
          WORKING_USER="runner"
          WORKING_PASS="${{ secrets.VNC_PASSWORD }}"

          # åˆ¥ã®æ–¹æ³•ã§ã‚‚ãƒ†ã‚¹ãƒˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç›´æ¥æŒ‡å®šï¼‰
          pkill x11vnc || true
          x11vnc -create -forever -shared -passwd "${{ secrets.VNC_PASSWORD }}" &
          sleep 5

          # æœ€çµ‚ç¢ºèª
          if pgrep -f x11vnc > /dev/null && lsof -i :5900 > /dev/null; then
            echo "âœ… VNCã‚µãƒ¼ãƒãƒ¼ç¨¼åƒç¢ºèªå®Œäº†"
            AUTH_SUCCESS=true
          else
            echo "âŒ VNCã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã«å¤±æ•—"
            AUTH_SUCCESS=false
            exit 1
          fi

      - name: Setup noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          ./utils/novnc_proxy --vnc 127.0.0.1:5900 --listen 127.0.0.1:6080 &
          sleep 5

      - name: Setup ngrok and Display Verified Info
        run: |
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 127.0.0.1:6080 &
          sleep 10

          URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')

          echo "=========================================="
          echo "ğŸ‰ VNCæ¥ç¶šæƒ…å ±ï¼ˆãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼‰"
          echo "=========================================="
          echo "ğŸ“ URL: $URL"
          echo ""
          echo "âœ… ç¢ºèªæ¸ˆã¿ã®èªè¨¼æƒ…å ±:"
          echo "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å: runnerï¼ˆã¾ãŸã¯ç©ºæ¬„ï¼‰"
          echo "ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: Your VNC_PASSWORD"
          echo ""
          echo "ğŸ“ æ¥ç¶šæ‰‹é †:"
          echo "1. ä¸Šè¨˜URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã"
          echo "2. Connectã‚’ã‚¯ãƒªãƒƒã‚¯" 
          echo "3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ä¸è¦ï¼‰"
          echo "=========================================="

      - name: Keep Alive
        run: sleep 21600
