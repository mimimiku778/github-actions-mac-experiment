name: Working Mac VNC with Display
on: workflow_dispatch

jobs:
  mac-vnc:
    runs-on: macos-latest
    steps:
      - name: Setup VNC with Display
        run: |
          brew install x11vnc
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ secrets.VNC_PASSWORD }}" ~/.vnc/passwd
          
          # ‰ªÆÊÉ≥„Éá„Ç£„Çπ„Éó„É¨„Ç§„Çí‰ΩúÊàê„Åó„Å¶‰Ωï„ÅãË°®Á§∫„Åô„Çã
          export DISPLAY=:1
          Xvfb :1 -screen 0 1280x720x24 &
          sleep 3
          
          # „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁí∞Â¢É„ÇíËµ∑Âãï
          # macOS„ÅÆÂ†¥Âêà„ÅØÂ∞ë„ÅóÈÅï„ÅÜ„Ç¢„Éó„É≠„Éº„ÉÅ„ÅåÂøÖË¶Å
          open -a Terminal &
          open -a Safari &
          
          # x11vnc„ÇíËµ∑Âãï
          x11vnc -display :1 -forever -shared -rfbauth ~/.vnc/passwd &
          sleep 5

      - name: Alternative - Use built-in Screen Sharing
        run: |
          # macOS„ÅÆÂÜÖËîµScreen Sharing„ÇíË©¶„Åô
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "${{ secrets.VNC_PASSWORD }}" \
            -restart -agent -privs -all
          
          # „Åæ„Åü„ÅØ„ÄÅ„Ç∑„É≥„Éó„É´„Å´„Ç¢„Éó„É™„ÇíËµ∑Âãï
          open -a Calculator
          open -a TextEdit
          
          # VNC„ÇíÂÜçËµ∑Âãï
          pkill x11vnc || true
          x11vnc -create -geometry 1280x720 -forever -shared -rfbauth ~/.vnc/passwd -bg -o /tmp/x11vnc.log &
          sleep 10

      - name: Setup noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          
          # Áµ±Âêà„Éó„É≠„Ç≠„Ç∑„Çí‰ΩøÁî®
          ./utils/novnc_proxy --vnc 127.0.0.1:5900 --listen 127.0.0.1:6080 &
          sleep 5

      - name: Setup ngrok
        run: |
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 127.0.0.1:6080 &
          sleep 10
          
          URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "=========================================="
          echo "üåê „Éñ„É©„Ç¶„Ç∂„Åß„Ç¢„ÇØ„Çª„Çπ:"
          echo "$URL"
          echo ""
          echo "„Éë„Çπ„ÉØ„Éº„Éâ: Your VNC_PASSWORD"
          echo ""
          echo "üí° „ÇÇ„ÅóÁîªÈù¢„ÅåÁúü„Å£Êöó„Å™Â†¥Âêà:"
          echo "   - Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„É™„Éï„É¨„ÉÉ„Ç∑„É•"
          echo "   - VNCÊé•Á∂öÂæå„ÄÅ„Éû„Ç¶„Çπ„ÇíÂãï„Åã„Åó„Å¶„Åø„Çã"
          echo "=========================================="

      - name: Debug Display
        run: |
          echo "=== Display Status ==="
          echo "DISPLAY=$DISPLAY"
          
          # x11vnc„ÅÆ„É≠„Ç∞Á¢∫Ë™ç
          cat /tmp/x11vnc.log 2>/dev/null | tail -20 || echo "No log file"
          
          # „Éó„É≠„Çª„ÇπÁ¢∫Ë™ç
          ps aux | grep -E "(Xvfb|x11vnc)" | grep -v grep

      - name: Keep Alive
        run: sleep 21600