# Reverse MacOS VNC for GitHub Actions
# This YAML establishes the "build" workflow where we will execute all required scripts
# During the process, it should get stuck at the last step where it creates a new tunnel on ngrok.

name: macOS
on: [push]
defaults:
  run:
    shell: bash
jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: Preparing environment...
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
      # legacy run command script-- run: ./scripts/configure-legacy.sh
      run: |
        # Install ngrok
        brew install ngrok/ngrok/ngrok
        # Authenticate ngrok
        ngrok config add-authtoken $NGROK_AUTH_TOKEN
    - name: Install Terminal Web Interface
      run: |
        # Install ttyd for web-based terminal access
        brew install ttyd
        # Create a simple web interface
        mkdir -p ~/web-interface
    - name: Starting Web Terminal...
      env:
        VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
      run: |
        # Setup shell environment (use zsh without changing system shell)
        export SHELL=/bin/zsh
        # Start web-based terminal interface with zsh
        ttyd -p 7681 -W /bin/zsh &
        sleep 2
        echo "Web terminal started on port 7681 with zsh"
        # Create a simple HTML page showing system info
        echo "macOS GitHub Actions Terminal Ready" > ~/status.txt
        echo "System: $(uname -a)" >> ~/status.txt
        echo "Shell: $SHELL" >> ~/status.txt
        echo "Time: $(date)" >> ~/status.txt
        cat ~/status.txt
    - name: Creating tunnel with ngrok...
      run: |
        # Start ngrok HTTP tunnel for web terminal (free tier supports HTTP)
        ngrok http 7681 --log stdout &
        sleep 15
        # Show connection info clearly
        echo ""
        echo "=============================================="
        echo "üöÄ macOS GitHub Actions Remote Access Ready!"
        echo "=============================================="
        echo ""
        
        # Get ngrok URL
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*"' | cut -d'"' -f4)
        
        echo "üì± Terminal Access URL:"
        echo "   $NGROK_URL"
        echo ""
        echo "üíª System Information:"
        echo "   OS: $(uname -s) $(uname -r)"
        echo "   User: $(whoami)"
        echo "   Home: $HOME"
        echo "   Shell: $SHELL"
        echo "   Tools: $(which brew git python3 node | tr '\n' ' ')"
        echo ""
        echo "üîë Important Notes:"
        echo "   - User 'runner' has no password set"
        echo "   - If prompted for password, just press Enter"
        echo "   - Or use: sudo -n (no password sudo for some commands)"
        echo ""
        echo "‚ö° Access your macOS terminal in browser:"
        echo "   Open: $NGROK_URL"
        echo ""
        echo "=============================================="
        echo "üîÑ Keeping session alive..."
        echo "=============================================="
        
        # Keep the workflow running and show URL periodically
        while true; do 
          sleep 60
          echo "üïê $(date): Session active - URL: $NGROK_URL"
        done