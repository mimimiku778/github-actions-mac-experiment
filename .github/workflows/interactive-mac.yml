name: Working Mac VNC
on: workflow_dispatch

jobs:
  mac-vnc:
    runs-on: macos-latest
    steps:
      - name: Setup VNC
        run: |
          brew install x11vnc
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ secrets.VNC_PASSWORD }}" ~/.vnc/passwd
          x11vnc -create -forever -shared -rfbauth ~/.vnc/passwd &
          sleep 5

      - name: Setup noVNC with IPv4
        run: |
          # noVNCã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          
          # IPv4ï¼ˆ127.0.0.1ï¼‰ã‚’æ˜ç¤ºçš„ã«ä½¿ç”¨
          python3 -m http.server 6080 --bind 127.0.0.1 &
          sleep 3
          
          # WebSocketãƒ—ãƒ­ã‚­ã‚·ã‚‚IPv4ã§èµ·å‹•
          ./utils/websockify/websockify.py --web=. 127.0.0.1:6081 127.0.0.1:5900 &
          sleep 5
          
          # ãƒãƒ¼ãƒˆç¢ºèª
          echo "=== Port check ==="
          netstat -an | grep LISTEN | grep -E "(6080|6081|5900)"

      - name: Setup ngrok with IPv4
        run: |
          brew install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          
          # IPv4ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
          ngrok http 127.0.0.1:6080 &
          sleep 10
          
          # ãƒ†ã‚¹ãƒˆ
          echo "=== Local test ==="
          curl -I http://127.0.0.1:6080 || echo "Failed to connect"
          
          URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "=========================================="
          echo "ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹:"
          echo "$URL/vnc.html"
          echo ""
          echo "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: Your VNC_PASSWORD"
          echo "=========================================="

      - name: Keep Alive
        run: sleep 21600